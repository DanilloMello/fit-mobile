name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ============================================================
      # 1. Checkout
      # ============================================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diffs

      # ============================================================
      # 2. Setup Node.js
      # ============================================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ============================================================
      # 3. Install Dependencies
      # ============================================================
      - name: ğŸ“š Install dependencies
        run: npm ci

      # ============================================================
      # 4. TypeScript Type Check
      # ============================================================
      - name: ğŸ” TypeScript type check
        run: npx tsc --noEmit

      # ============================================================
      # 5. Lint Check
      # ============================================================
      - name: ğŸ¨ Run ESLint
        run: npx nx run-many --target=lint --all --parallel=3

      # ============================================================
      # 6. Run Tests
      # ============================================================
      - name: ğŸ§ª Run tests
        run: npx nx run-many --target=test --all --parallel=3 --coverage

      # ============================================================
      # 7. Generate Test Report
      # ============================================================
      - name: ğŸ“Š Publish test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: '**/junit.xml'
          reporter: jest-junit
          fail-on-error: true

      # ============================================================
      # 8. Test Coverage
      # ============================================================
      - name: ğŸ“¤ Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: '**/coverage/lcov.info'
          flags: unittests
          name: codecov-umbrella

      # ============================================================
      # 9. Build Check
      # ============================================================
      - name: ğŸ”¨ Build project
        run: npx nx run-many --target=build --all --parallel=3 || echo "Build target not configured - TypeScript check passed"

      # ============================================================
      # 10. API Registry Compliance Check
      # ============================================================
      - name: ğŸ”— Check API endpoint compliance
        run: |
          echo "Checking if API client changes follow API_REGISTRY.md..."

          # Get list of modified API files
          MODIFIED_API_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(api|client|service)\.(ts|tsx)$" | grep -v "\.spec\." || true)

          if [ -n "$MODIFIED_API_FILES" ]; then
            echo "Modified API-related files detected:"
            echo "$MODIFIED_API_FILES"
            echo ""
            echo "âš ï¸ REMINDER: Verify all API calls match fit-common/docs/API_REGISTRY.md"
            echo "This is a manual check - reviewers should verify endpoint compliance"
          else
            echo "âœ… No API client changes detected"
          fi

      # ============================================================
      # 11. Code Quality Checks
      # ============================================================
      - name: ğŸ” Check for console.log
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -n "console\.log" 2>/dev/null; then
            echo "âš ï¸ WARNING: Found console.log statements - consider removing"
            # Don't fail, just warn
          else
            echo "âœ… No console.log found"
          fi

      - name: ğŸ” Check for debugger statements
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -n "debugger" 2>/dev/null; then
            echo "âŒ Found debugger statements - must be removed"
            exit 1
          else
            echo "âœ… No debugger statements found"
          fi

      - name: ğŸ” Check for 'any' type usage
        run: |
          ANY_COUNT=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(ts|tsx)$" | xargs grep -c ":\s*any\b" 2>/dev/null | awk '{sum+=$1} END {print sum}' || echo 0)
          if [ "$ANY_COUNT" -gt 0 ]; then
            echo "âš ï¸ WARNING: Found $ANY_COUNT 'any' type usage - prefer specific types"
            # Don't fail, just warn
          else
            echo "âœ… No 'any' type usage found"
          fi

      # ============================================================
      # 12. Dependency Security Check
      # ============================================================
      - name: ğŸ”’ Check for security vulnerabilities
        run: npm audit --audit-level=high || echo "Security vulnerabilities found - please review"

      # ============================================================
      # 13. Check Lock File Sync
      # ============================================================
      - name: ğŸ” Check package-lock.json sync
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "package.json"; then
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "package-lock.json"; then
              echo "âœ… Lock file updated with package.json"
            else
              echo "âš ï¸ WARNING: package.json modified but package-lock.json not updated"
              echo "Run 'npm install' to update lock file"
              exit 1
            fi
          else
            echo "âœ… No package.json changes"
          fi

      # ============================================================
      # 14. Bundle Size Check (Optional)
      # ============================================================
      - name: ğŸ“¦ Check bundle size
        if: ${{ github.event_name == 'pull_request' }}
        continue-on-error: true
        run: |
          echo "Bundle size check - implement if needed with size-limit or similar tools"

      # ============================================================
      # 15. Summary
      # ============================================================
      - name: âœ… Validation complete
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All PR validations passed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
