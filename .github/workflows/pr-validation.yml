name: PR Validation

on:
  pull_request:
    branches: [ master, develop ]
  push:
    branches: [ master, develop ]

jobs:
  # ============================================================
  # JOB 1: Code quality, tests, and bundle â€” all branches
  # ============================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript type check
        run: npx tsc --noEmit

      - name: ğŸ¨ Run ESLint
        run: npx nx run-many --target=lint --all --parallel=3

      - name: ğŸ§ª Run tests
        run: npx nx run-many --target=test --all --parallel=3 --coverage

      - name: ğŸ“Š Publish test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: '**/junit.xml'
          reporter: jest-junit
          fail-on-error: true

      - name: ğŸ“¤ Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: '**/coverage/lcov.info'
          flags: unittests

      - name: ğŸ“¦ Expo Android bundle validation
        run: |
          cd apps/mobile
          npx expo export --platform android --output-dir /tmp/expo-bundle
          echo "âœ… Bundle size: $(du -sh /tmp/expo-bundle | cut -f1)"

      - name: ğŸ”— Check API endpoint compliance
        run: |
          BASE=${GITHUB_BASE_REF:-HEAD~1}
          MODIFIED_API=$(git diff --name-only origin/$BASE...HEAD 2>/dev/null | grep -E "(api|client|service)\.(ts|tsx)$" | grep -v "\.spec\." || true)
          if [ -n "$MODIFIED_API" ]; then
            echo "âš ï¸ Modified API files â€” reviewers verify against API_REGISTRY.md:"
            echo "$MODIFIED_API"
          else
            echo "âœ… No API client changes"
          fi

      - name: ğŸ” Check for debugger statements
        run: |
          BASE=${GITHUB_BASE_REF:-HEAD~1}
          if git diff --name-only origin/$BASE...HEAD 2>/dev/null | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -n "debugger" 2>/dev/null; then
            echo "âŒ Found debugger statements â€” remove before merging"
            exit 1
          fi
          echo "âœ… No debugger statements"

      - name: ğŸ” Check for console.log
        run: |
          BASE=${GITHUB_BASE_REF:-HEAD~1}
          if git diff --name-only origin/$BASE...HEAD 2>/dev/null | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -n "console\.log" 2>/dev/null; then
            echo "âš ï¸ WARNING: Found console.log â€” consider removing"
          else
            echo "âœ… No console.log"
          fi

      - name: ğŸ” Check package-lock.json sync
        run: |
          BASE=${GITHUB_BASE_REF:-HEAD~1}
          if git diff --name-only origin/$BASE...HEAD 2>/dev/null | grep -q "package.json"; then
            if git diff --name-only origin/$BASE...HEAD 2>/dev/null | grep -q "package-lock.json"; then
              echo "âœ… Lock file updated"
            else
              echo "âŒ package.json changed but package-lock.json not updated â€” run 'npm install'"
              exit 1
            fi
          else
            echo "âœ… No package.json changes"
          fi

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found â€” review before merging"

      - name: âœ… Validation complete
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All validations passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================
  # JOB 2: EAS Build â€” only on master push or PR to master
  # ============================================================
  eas-build:
    name: EAS Build (preview APK)
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.ref == 'refs/heads/master' ||
      (github.event_name == 'pull_request' && github.base_ref == 'master')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ğŸ“± EAS Build (Android preview APK)
        working-directory: apps/mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build \
            --platform android \
            --profile preview \
            --non-interactive \
            --no-wait
          echo "âœ… EAS build queued â€” check https://expo.dev/accounts/nillodbm/projects/connecthealth"
