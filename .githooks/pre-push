#!/bin/bash
# Pre-push hook for fit-mobile
# Validates TypeScript, ESLint, tests, and Expo bundle before any push

set -e

echo "ğŸ” Running pre-push validations for fit-mobile..."
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

step()    { echo -e "${YELLOW}â–¶ $1${NC}"; }
success() { echo -e "${GREEN}âœ“ $1${NC}"; echo ""; }
error()   { echo -e "${RED}âœ— $1${NC}"; echo ""; FAILED=1; }

# ============================================================
# 0. Uncommitted changes
# ============================================================
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${RED}âœ— Uncommitted changes detected${NC}"
    echo ""
    git status --short
    echo ""
    echo "Commit your changes before pushing:"
    echo "  git add <files> && git commit -m 'feat(scope): description'"
    echo ""
    exit 1
fi

# ============================================================
# 1. TypeScript type check
# ============================================================
step "Running TypeScript type check..."
if npx tsc --project apps/mobile/tsconfig.json --noEmit; then
    success "Type check passed"
else
    error "TypeScript type errors found. Fix before pushing."
fi

# ============================================================
# 2. Lint
# ============================================================
step "Running ESLint..."
if npx nx run-many --target=lint --all --quiet; then
    success "Lint check passed"
else
    error "ESLint errors found. Run 'npx nx run-many --target=lint --all --fix' to auto-fix."
fi

# ============================================================
# 3. Tests
# ============================================================
step "Running tests..."
if npx nx run-many --target=test --all --quiet; then
    success "All tests passed"
else
    error "Tests failed. Fix before pushing."
fi

# ============================================================
# 4. Expo bundle validation (every push)
# ============================================================
step "Validating Expo Android bundle..."
BUNDLE_DIR=$(mktemp -d)
if (cd apps/mobile && npx expo export --platform android --output-dir "$BUNDLE_DIR" 2>&1); then
    success "Expo Android bundle valid"
else
    error "Expo bundle failed. Debug with: cd apps/mobile && npx expo export --platform android --output-dir /tmp/test"
fi
rm -rf "$BUNDLE_DIR"

# ============================================================
# 5. Guidelines
# ============================================================
step "Validating coding guidelines..."

PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || git rev-parse HEAD)

CONSOLE_LOG_FILES=$(git diff "$PREV_COMMIT" --name-only --diff-filter=ACM 2>/dev/null | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -l "console\.log" 2>/dev/null || true)
if [ -n "$CONSOLE_LOG_FILES" ]; then
    echo -e "${YELLOW}  âš  Found console.log in:${NC}"
    echo "$CONSOLE_LOG_FILES" | sed 's/^/    - /'
    echo "  Remove before merging to master"
    echo ""
fi

DEBUGGER_FILES=$(git diff "$PREV_COMMIT" --name-only --diff-filter=ACM 2>/dev/null | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -l "debugger" 2>/dev/null || true)
[ -n "$DEBUGGER_FILES" ] && error "Found 'debugger' statements â€” remove before pushing:\n$DEBUGGER_FILES"

success "Guidelines validation complete"

# ============================================================
# 6. API Registry compliance
# ============================================================
step "Checking API endpoint compliance..."
MODIFIED_API_FILES=$(git diff "$PREV_COMMIT" --name-only --diff-filter=ACM 2>/dev/null | grep -E "(api|client|service)\.(ts|tsx)$" | grep -v "\.spec\." || true)
if [ -n "$MODIFIED_API_FILES" ]; then
    echo "  Modified API files:"
    echo "$MODIFIED_API_FILES" | sed 's/^/    - /'
    echo ""
    echo -e "${YELLOW}  âš  Ensure all API calls match API_REGISTRY.md in fit-common${NC}"
    echo ""
    success "API Registry compliance â€” review required before merging"
else
    success "No API client changes"
fi

# ============================================================
# 7. Dependency check
# ============================================================
step "Checking dependencies..."
if git diff "$PREV_COMMIT" --name-only 2>/dev/null | grep -q "package.json"; then
    if git diff "$PREV_COMMIT" --name-only 2>/dev/null | grep -q "package-lock.json"; then
        success "Lock file updated"
    else
        error "package.json changed but package-lock.json not updated â€” run 'npm install'"
    fi
else
    success "No dependency changes"
fi

# ============================================================
# Summary
# ============================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}âŒ Pre-push validation FAILED${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Fix the errors above before pushing."
    echo "To bypass this hook (NOT recommended): git push --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ… All validations passed!${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Proceeding with push..."
    echo ""
fi
